<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Поиск дешёвых авиабилетов</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
        }

        .search-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
        }

        .results {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .ticket {
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            transition: box-shadow 0.3s;
        }

        .ticket:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .price {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .buy-btn {
            background: #4CAF50;
            padding: 10px 20px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .buy-btn:hover {
            background: #45a049;
        }

        .loading {
            text-align: center;
            color: #666;
            font-size: 18px;
            padding: 20px;
        }

        .ticket-info {
            margin: 10px 0;
            color: #666;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>✈️ Поиск дешёвых авиабилетов</h1>
            <p>Найдите лучшие цены на авиабилеты по всему миру</p>
        </div>

        <div class="search-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="origin">Откуда</label>
                    <input type="text" id="origin" placeholder="Код города (MOW)" value="MOW">
                </div>
                <div class="form-group">
                    <label for="destination">Куда</label>
                    <input type="text" id="destination" placeholder="Код города (LED)" value="LED">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="depart_date">Туда</label>
                    <input type="date" id="depart_date" value="2025-05-01">
                </div>
                <div class="form-group">
                    <label for="return_date">Обратно</label>
                    <input type="date" id="return_date" value="2025-05-10">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="passengers">Пассажиры</label>
                    <select id="passengers">
                        <option value="1">1 пассажир</option>
                        <option value="2">2 пассажира</option>
                        <option value="3">3 пассажира</option>
                        <option value="4">4 пассажира</option>
                        <option value="5">5 пассажиров</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="baggage">Багаж</label>
                    <select id="baggage">
                        <option value="any">Любой</option>
                        <option value="with">С багажом</option>
                        <option value="without">Без багажа</option>
                    </select>
                </div>
            </div>

            <button type="button" id="searchBtn">Найти билеты</button>
        </div>

        <div class="results">
            <div id="results"></div>
        </div>
    </div>

    <script>
        // Обработчик клика на кнопку поиска
        document.getElementById('searchBtn').addEventListener('click', async () => {
            const origin = document.getElementById('origin').value;
            const destination = document.getElementById('destination').value;
            const depart_date = document.getElementById('depart_date').value;
            const return_date = document.getElementById('return_date').value;
            const passengers = document.getElementById('passengers').value;
            const baggage = document.getElementById('baggage').value;

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Ищем билеты...</div>';

            try {
                // Запрос к API Travelpayouts
                const response = await fetch(`/api/search?origin=${origin}&destination=${destination}&depart_date=${depart_date}&return_date=${return_date}`);
                const data = await response.json();

                if (data.data) {
                    displayTickets(data.data, passengers, baggage);
                } else {
                    resultsDiv.innerHTML = '<div class="loading">Билеты не найдены</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML = '<div class="loading">Ошибка при поиске: ' + error.message + '</div>';
            }
        });

        // Отображение билетов с фильтрацией и расчётом цены
        function displayTickets(tickets, passengers, baggage) {
            const resultsDiv = document.getElementById('results');
            let html = '<h2>Найденные билеты:</h2>';
            let foundTickets = 0;

            for (let date in tickets) {
                const ticket = tickets[date];

                // Фильтр по багажу (пока упрощённый)
                if (baggage === 'with' && ticket.value < 5000) continue;
                if (baggage === 'without' && ticket.value > 10000) continue;

                // Расчёт цены с учётом пассажиров
                const totalPrice = ticket.value * parseInt(passengers);

                html += `
                    <div class="ticket">
                        <h3>Рейс: ${ticket.origin} → ${ticket.destination}</h3>
                        <div class="ticket-info">
                            <p><strong>Дата:</strong> ${date}</p>
                            <p><strong>Авиакомпания:</strong> ${getAirlineName(ticket.airline)} ${ticket.airline || ''}</p>
                        </div>
                        <div class="price">${totalPrice} ${ticket.currency} за ${passengers} пассажира(ов)</div>
                        <p><strong>Цена за 1 пассажира:</strong> ${ticket.value} ${ticket.currency}</p>
                        <button class="buy-btn" onclick="buyTicket('${ticket.origin}', '${ticket.destination}', '${date}', ${ticket.value})">
                            Купить билет
                        </button>
                    </div>
                `;
                foundTickets++;
            }

            if (foundTickets === 0) {
                html = '<div class="loading">Билеты не найдены по заданным критериям</div>';
            }

            resultsDiv.innerHTML = html;
        }

        // Функция для получения названия авиакомпании
        function getAirlineName(code) {
            const airlines = {
                'SU': 'Аэрофлот',
                'S7': 'S7 Airlines',
                'FV': 'Rossiya Airlines',
                'UT': 'UTair',
                'AZ': 'Alitalia',
                'LH': 'Lufthansa',
                'AF': 'Air France',
                'BA': 'British Airways'
            };
            return airlines[code] || 'Авиакомпания';
        }

        // Функция покупки билета - редирект через Travelpayouts
        function buyTicket(origin, destination, departDate, price) {
            // Форматируем дату для Aviasales
            const formattedDate = departDate.replace(/-/g, '');

            // Создаём URL для редиректа через Travelpayouts
            // Это отправит пользователя через систему Travelpayouts
            // которая может направить на сайт авиакомпании
            const searchRoute = `${origin}${formattedDate}${destination}1`;
            const redirectUrl = `https://hydra.aviasales.ru/searches/new?marker=ND56827&url=https%3A%2F%2Fwww.aviasales.ru%2Fsearch%2F${searchRoute}`;

            // Открываем в новой вкладке
            window.open(redirectUrl, '_blank');

            // Отправляем событие в Travelpayouts для отслеживания
            if (window.tp) {
                window.tp('track', 'ticket_purchase', {
                    origin: origin,
                    destination: destination,
                    date: departDate,
                    price: price
                });
            }
        }
    </script>

    <!-- Скрипт Travelpayouts для отслеживания -->
    <script data-noptimize="1" data-cfasync="false" data-wpfc-render="false">
      (function () {
          var script = document.createElement("script");
          script.async = 1;
          script.src = 'https://emrldco.com/NDU2ODI3.js?t=456827';
          document.head.appendChild(script);
      })();
    </script>
</body>
</html>